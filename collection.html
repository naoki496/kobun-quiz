<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>ã‚«ãƒ¼ãƒ‰å›³é‘‘</title>
  <link rel="stylesheet" href="./styles.css">
</head>

<body>
  <h1>ğŸ“– ã‚«ãƒ¼ãƒ‰å›³é‘‘</h1>

  <div class="panel">
    <div class="panel-inner">

      <div id="cardGrid" class="card-grid"></div>

      <div style="margin-top:16px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;">
        <a href="./index.html" class="pill" style="text-decoration:none;">â† ã‚¯ã‚¤ã‚ºã«æˆ»ã‚‹</a>
        <button id="btnReload" class="pill" type="button">å†èª­ã¿è¾¼ã¿</button>
        <button id="btnReset" class="pill" type="button">ã‚«ãƒ¼ãƒ‰ä¿å­˜ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
      </div>

      <!-- Debug -->
      <div id="debugBox" style="margin-top:16px; font-size:12px; opacity:.85; line-height:1.5;"></div>

    </div>
  </div>

<script>
/* ===== Card Poolï¼ˆapp.js ã¨ä¸€è‡´ã•ã›ã‚‹ï¼‰===== */
const CARD_POOL = {
  3: [{ id: "sei_shonagon", name: "æ¸…å°‘ç´è¨€", img: "./assets/cards/sei_shonagon.png" }],
  4: [{ id: "murasaki", name: "ç´«å¼éƒ¨", img: "./assets/cards/murasaki.png" }],
  5: [{ id: "basho", name: "æ¾å°¾èŠ­è•‰", img: "./assets/cards/basho.png" }],
};

const STORAGE_KEY_CARD_COUNTS = "kobunQuiz.v1.cardCounts";

/* ===== helpers ===== */
function loadCardCountsSafe() {
  const raw = localStorage.getItem(STORAGE_KEY_CARD_COUNTS);
  if (!raw) return { raw: null, obj: {} };

  try {
    const obj = JSON.parse(raw);
    if (obj && typeof obj === "object") return { raw, obj };
    return { raw, obj: {} };
  } catch (e) {
    return { raw, obj: {}, error: String(e) };
  }
}

function listAllLocalStorageKeys() {
  const keys = [];
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    keys.push(k);
  }
  keys.sort();
  return keys;
}

/* ===== render ===== */
function renderCollection() {
  const grid = document.getElementById("cardGrid");
  const debug = document.getElementById("debugBox");

  const { raw, obj: counts, error } = loadCardCountsSafe();
  const allCards = Object.values(CARD_POOL).flat();

  // å–å¾—æ¸ˆã¿ï¼ˆå›æ•°>0ï¼‰
  const obtained = allCards
    .map(c => ({...c, count: Number(counts[c.id] ?? 0)}))
    .filter(c => c.count > 0);

  if (!obtained.length) {
    grid.innerHTML = `
      <div style="opacity:.75; padding:18px;">
        ã¾ã ã‚«ãƒ¼ãƒ‰ã‚’ç²å¾—ã—ã¦ã„ã¾ã›ã‚“ã€‚<br>
        <b>é€šå¸¸ãƒ¢ãƒ¼ãƒ‰</b>ã§10å•å®Œèµ°ã—ã€<b>â˜…3ä»¥ä¸Š</b>ã§ã‚«ãƒ¼ãƒ‰ãŒå‡ºã¾ã™ã€‚<br>
        ï¼ˆçµæœç”»é¢ã«ã‚«ãƒ¼ãƒ‰è¡¨ç¤ºãŒå‡ºãŸã‹ã‚‚ç¢ºèªã—ã¦ãã ã•ã„ï¼‰
      </div>
    `;
  } else {
    grid.innerHTML = obtained.map(card => `
      <div class="card-item">
        <img src="${card.img}" alt="${card.name}">
        <div class="card-item-name">${card.name}</div>
        <div class="card-item-count">æ‰€æŒï¼š${card.count}æš</div>
      </div>
    `).join("");
  }

  // Debug info
  const keys = listAllLocalStorageKeys();
  const summaryCounts = allCards.map(c => `${c.id}:${counts[c.id] ?? 0}`).join(" / ");
  debug.innerHTML = `
    <div style="padding:10px; border-radius:14px; background:rgba(255,255,255,0.04); border:1px solid rgba(255,255,255,0.08);">
      <div><b>Debug</b></div>
      <div>origin: <code>${location.origin}</code></div>
      <div>path: <code>${location.pathname}</code></div>
      <div>storage key: <code>${STORAGE_KEY_CARD_COUNTS}</code></div>
      <div>raw: <code>${raw ? raw.replace(/</g,"&lt;") : "(null)"}</code></div>
      ${error ? `<div style="color:#ff8;">JSON parse error: <code>${error}</code></div>` : ""}
      <div>counts: <code>${summaryCounts}</code></div>
      <div>localStorage keys: <code>${keys.join(", ") || "(none)"}</code></div>
      <div style="opacity:.75; margin-top:6px;">
        â€» raw ãŒ (null) ã®å ´åˆã€ã‚«ãƒ¼ãƒ‰ä¿å­˜ãŒ localStorage ã«å…¥ã£ã¦ã„ã¾ã›ã‚“ã€‚<br>
        ãã®å ´åˆã€(a) ã¾ã â˜…3ä»¥ä¸Šã‚’å–ã£ã¦ã„ãªã„ / (b) ä¿å­˜ãŒãƒ¡ãƒ¢ãƒªã«è½ã¡ã¦ã„ã‚‹ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶è¨­å®š/ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆç­‰ï¼‰å¯èƒ½æ€§ãŒé«˜ã„ã§ã™ã€‚
      </div>
    </div>
  `;
}

document.getElementById("btnReload").addEventListener("click", renderCollection);

document.getElementById("btnReset").addEventListener("click", () => {
  if (!confirm("ã‚«ãƒ¼ãƒ‰ä¿å­˜ï¼ˆlocalStorageï¼‰ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ")) return;
  localStorage.removeItem(STORAGE_KEY_CARD_COUNTS);
  renderCollection();
});

renderCollection();
</script>
</body>
</html>
